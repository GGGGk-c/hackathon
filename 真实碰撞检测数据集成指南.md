# 🛰️ 真实碰撞检测数据集成指南

## ✅ 已完成的功能

我已经为你的系统集成了**真实的碰撞检测（Conjunction）数据**功能！现在系统支持从Space-Track.org获取真实的卫星碰撞预警数据。

---

## 📋 功能概览

### 🆕 新增服务

#### 1. **Space-Track.org 认证服务** (`src/services/spaceTrackService.ts`)

这是一个完整的Space-Track.org API客户端，支持：

- ✅ 自动认证和会话管理
- ✅ 获取CDM (Conjunction Data Messages) 碰撞预警数据
- ✅ 获取TLE (Two-Line Element) 轨道数据
- ✅ 卫星搜索功能
- ✅ 智能缓存机制（减少API调用）
- ✅ 请求超时保护
- ✅ 自动错误处理

**主要方法**：
```typescript
// 认证
await spaceTrackService.authenticate()

// 获取碰撞数据（未来7天）
const cdmData = await spaceTrackService.fetchConjunctionData('25544', 7)

// 获取TLE轨道数据
const tle = await spaceTrackService.fetchTLE('25544')

// 搜索卫星
const results = await spaceTrackService.searchSatellite('ISS')
```

#### 2. **增强的碰撞检测服务** (`src/services/conjunctionDataService.ts`)

完全重写，现在支持：

- ✅ **真实数据模式**：从Space-Track.org获取真实的CDM数据
- ✅ **模拟数据模式**：用于演示和测试
- ✅ **智能回退**：真实数据失败时自动切换到模拟
- ✅ **严重程度评估**：基于碰撞概率和距离
- ✅ **建议行动生成**：根据威胁等级推荐操作

**新增函数**：
```typescript
// 检查碰撞威胁（支持真实和模拟）
const threats = await checkConjunctionThreats(satellite, noradCatId)

// 获取碰撞数据
const conjunctions = await fetchConjunctionData('25544')
```

#### 3. **升级的威胁监控** (`src/components/ThreatMonitor.tsx`)

现在集成了真实数据检测：

- ✅ 使用真实的CDM数据检测碰撞
- ✅ 使用真实的空间天气数据生成威胁
- ✅ 显示数据源指示器（Real Data / Simulated）
- ✅ 自动去重（避免重复威胁）
- ✅ 智能威胁限制（最多10个活跃威胁）

---

## 🚀 如何使用真实数据

### 步骤1️⃣：注册Space-Track.org账号

1. 访问：https://www.space-track.org/auth/register
2. 填写注册信息（免费账号）
3. 验证邮箱
4. 登录获取你的用户名和密码

### 步骤2️⃣：配置环境变量

1. 在项目根目录创建 `.env` 文件：

```bash
# Windows PowerShell
Copy-Item ENV_CONFIG_TEMPLATE.txt .env

# 或者手动创建
```

2. 编辑 `.env` 文件，填入你的凭据：

```env
# Space-Track.org 凭据
VITE_SPACETRACK_USERNAME=你的用户名
VITE_SPACETRACK_PASSWORD=你的密码

# 关闭模拟模式（使用真实数据）
VITE_USE_SIMULATION=false
```

### 步骤3️⃣：更新配置文件

编辑 `src/config/api.config.ts`，将 `USE_SIMULATION` 改为 `false`：

```typescript
/**
 * Simulation mode (set to false when using real APIs)
 */
export const USE_SIMULATION = false  // 改为 false
```

### 步骤4️⃣：（可选）为卫星添加NORAD ID

如果你想使用真实的碰撞数据，需要为你的卫星提供NORAD Catalog ID。

**方法1：在类型中添加字段**

编辑 `src/types/index.ts`：

```typescript
export interface Satellite {
  id: string
  name: string
  noradCatId?: string  // 新增：NORAD ID
  orbitalParams: OrbitalParameters
  mass: number
  crossSection: number
  status: 'active' | 'warning' | 'critical'
  lastUpdate: Date
}
```

**方法2：使用演示卫星的NORAD ID**

常见卫星的NORAD ID：
- 国际空间站 (ISS): `25544`
- 哈勃望远镜 (Hubble): `20580`
- 天宫空间站 (Tiangong): `48274`
- Starlink-1007: `44713`

### 步骤5️⃣：运行应用

```bash
npm run dev
```

---

## 🎯 数据显示

### 在威胁监控面板中

现在你会看到：

```
🚨 Threat Monitor                    [🗄️ Real Data]
                                      ↑
                                 数据源指示器
```

#### 🟢 **Real Data** = 使用真实的Space-Track.org数据
#### 🟡 **Simulated** = 使用模拟数据

### 真实威胁信息示例

```
🛰️ CONJUNCTION

Target: ISS (LEO)                           [CRITICAL]

Real conjunction detected with COSMOS 1408 DEB (ID: 51465). 
Miss distance: 245m

Time to Event    Probability    Detected
    3h 24m          78.5%       2 hours ago

3 suggested actions available
```

vs. 模拟威胁：

```
🛰️ CONJUNCTION

Target: ISS (LEO)                           [WARNING]

[SIMULATED] Close approach detected. Object 45382. 
Miss distance: 523m

Time to Event    Probability    Detected
    8h 15m          42.3%       just now

3 suggested actions available
```

---

## 📊 数据来源和更新频率

### CDM（碰撞预警消息）

- **来源**：Space-Track.org
- **数据**：
  - 碰撞时间 (TCA - Time of Closest Approach)
  - 错过距离 (Miss Distance)
  - 碰撞概率 (Probability)
  - 目标物体信息 (Object ID, Name)
- **查询范围**：未来7天
- **更新频率**：每10秒检查一次（可在配置中调整）
- **缓存时长**：5分钟

### 威胁严重程度评估

系统根据以下标准自动评估：

| 严重程度 | 条件 |
|---------|------|
| 🔴 **Critical** | 碰撞概率 > 80% 或 距离 < 100m |
| 🟠 **High** | 碰撞概率 > 50% 或 距离 < 300m |
| 🟡 **Medium** | 碰撞概率 > 30% 或 距离 < 500m |
| 🟢 **Low** | 其他情况 |

---

## 🔧 配置选项

### API配置 (`src/config/api.config.ts`)

```typescript
export const API_CONFIG = {
  spaceTrack: {
    baseUrl: 'https://www.space-track.org',
    authEndpoint: '/ajaxauth/login',
    endpoints: {
      cdm: '/basicspacedata/query/class/cdm_public',  // 碰撞数据
      satcat: '/basicspacedata/query/class/satcat',   // 卫星目录
      tle: '/basicspacedata/query/class/tle_latest',  // 轨道数据
    },
    credentials: {
      username: import.meta.env.VITE_SPACETRACK_USERNAME || '',
      password: import.meta.env.VITE_SPACETRACK_PASSWORD || '',
    },
  },
}
```

### 更新间隔

```typescript
export const UPDATE_INTERVALS = {
  spaceWeather: 5000,   // 空间天气：5秒
  threats: 10000,       // 威胁检测：10秒
  positions: 1000,      // 位置更新：1秒
}
```

### 缓存时长

```typescript
export const CACHE_DURATION = {
  spaceWeather: 60000,   // 1分钟
  conjunction: 300000,   // 5分钟
  tle: 3600000,          // 1小时
}
```

### 速率限制

Space-Track.org API限制：
- **每分钟**：20个请求
- **每小时**：200个请求

系统会自动缓存数据以避免超出限制。

---

## 🐛 故障排查

### 问题1：显示"Simulated"而不是"Real Data"

**原因**：
- Space-Track凭据未配置
- `USE_SIMULATION` 仍为 `true`
- 认证失败

**解决方案**：
1. 检查 `.env` 文件中的用户名和密码
2. 确认 `api.config.ts` 中 `USE_SIMULATION = false`
3. 查看浏览器控制台的错误信息

### 问题2：没有碰撞威胁显示

**这是正常的！** 真实世界中：
- 大多数卫星大部分时间是安全的
- CDM数据只在检测到潜在碰撞时生成
- 可能需要等待一段时间才能看到真实威胁

**测试建议**：
1. 使用ISS (NORAD: 25544)，它的CDM数据较多
2. 调整严重程度阈值（在代码中）
3. 临时使用模拟模式验证系统工作正常

### 问题3：认证失败

**错误消息**：`❌ Space-Track authentication failed: 401`

**可能原因**：
- 用户名或密码错误
- Space-Track账号未激活
- Space-Track服务器问题

**解决方案**：
1. 在浏览器中登录 https://www.space-track.org 验证凭据
2. 检查邮箱是否已验证账号
3. 等待几分钟后重试（可能是临时问题）

### 问题4：CORS错误

**错误消息**：`Access to fetch at 'https://www.space-track.org' from origin...`

**原因**：Space-Track.org使用cookie认证，浏览器CORS限制

**解决方案**：
- **开发环境**：需要配置代理或使用浏览器扩展
- **生产环境**：建议通过后端代理API请求

在 `vite.config.ts` 中添加代理：

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/spacetrack': {
        target: 'https://www.space-track.org',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/spacetrack/, ''),
      },
    },
  },
})
```

---

## 📈 数据流程图

```
开始
  ↓
ThreatMonitor 组件启动
  ↓
每10秒执行检查
  ↓
USE_SIMULATION? ──YES→ 生成模拟威胁 → 显示
  ↓ NO
Space-Track认证
  ↓
认证成功? ──NO→ 回退到模拟模式
  ↓ YES
获取CDM数据（带缓存）
  ↓
有碰撞数据? ──NO→ 继续监控
  ↓ YES
解析和评估威胁
  ↓
创建威胁对象
  ↓
添加到威胁列表
  ↓
显示给用户
```

---

## 🎓 Space-Track.org API 文档

### CDM（Conjunction Data Messages）

CDM是两个空间物体可能碰撞的预警消息。

**重要字段**：

| 字段 | 说明 | 示例 |
|------|------|------|
| `TCA` | 最接近时间 | `2025-10-26T14:23:45` |
| `MISS_DISTANCE` | 错过距离(km) | `0.245` |
| `PROBABILITY` | 碰撞概率 | `0.000785` (0.0785%) |
| `SAT_1_NAME` | 主卫星名称 | `ISS (ZARYA)` |
| `SAT_2_NAME` | 目标物体名称 | `COSMOS 1408 DEB` |
| `OBJECT_ID` | 物体ID | `51465` |

### 查询示例

获取ISS未来7天的碰撞预警：

```
GET /basicspacedata/query/class/cdm_public/SAT_1_ID/25544/TCA/>now/TCA/<2025-11-02/orderby/TCA asc/format/json
```

---

## 🆚 真实数据 vs 模拟数据对比

| 特性 | 真实数据 | 模拟数据 |
|------|---------|---------|
| **数据来源** | Space-Track.org | 随机生成 |
| **准确性** | 真实测量 | 随机值 |
| **更新频率** | Space-Track更新时 | 实时生成 |
| **威胁频率** | 取决于实际情况 | 每10秒15%概率 |
| **碰撞对象** | 真实物体ID和名称 | 随机ID |
| **需要网络** | ✅ 是 | ❌ 否 |
| **需要账号** | ✅ 是 | ❌ 否 |
| **适用场景** | 生产环境 | 演示/测试 |

---

## 🔐 安全建议

1. **不要提交 `.env` 文件到Git**
   ```bash
   # 确保 .gitignore 包含：
   .env
   .env.local
   ```

2. **使用环境变量**
   - 开发：`.env`
   - 生产：服务器环境变量

3. **保护你的凭据**
   - 不要在代码中硬编码
   - 不要分享你的Space-Track密码
   - 定期更换密码

---

## 📚 相关资源

- **Space-Track.org**
  - 官网：https://www.space-track.org
  - 文档：https://www.space-track.org/documentation
  - API指南：https://www.space-track.org/documentation#api

- **NOAA空间天气**
  - 官网：https://www.swpc.noaa.gov
  - API：https://www.swpc.noaa.gov/products/api

- **轨道力学**
  - TLE格式：https://en.wikipedia.org/wiki/Two-line_element_set
  - CDM格式：https://public.ccsds.org/Pubs/508x0b1e2c2.pdf

---

## ✅ 完成清单

使用真实数据前的检查：

- [ ] 已注册Space-Track.org账号
- [ ] 已创建并配置 `.env` 文件
- [ ] 已在 `api.config.ts` 中设置 `USE_SIMULATION = false`
- [ ] （可选）已为卫星添加NORAD ID
- [ ] 已测试认证（查看控制台日志）
- [ ] 威胁监控显示"Real Data"标签
- [ ] 理解真实威胁可能较少

---

## 🎉 完成！

你的系统现在支持**真实的碰撞检测数据**了！

**下一步**：
1. 运行 `npm run dev`
2. 添加一个卫星（使用真实NORAD ID）
3. 在Threat Monitor查看数据源指示器
4. 等待真实的碰撞预警（可能需要一些时间）

**提示**：如果想快速测试，可以：
- 暂时使用模拟模式验证功能
- 使用ISS (25544)，它的碰撞数据较多
- 调整威胁检测的阈值

有任何问题随时告诉我！🚀





